name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  release-android:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        global-json-file: global.json
        
    - name: Install MAUI
      run: dotnet workload install maui-android

    - name: Decode Keystore
      run: |
        $bytes = [System.Convert]::FromBase64String("${{ secrets.ANDROID_KEYSTORE_BASE64 }}")
        [System.IO.File]::WriteAllBytes("thebutton.keystore", $bytes)

    - name: Build and Sign AAB
      run: |
        dotnet publish src/TheButton.Mobile/TheButton.Mobile.csproj -f net10.0-android -c Release -p:AndroidKeyStore=true -p:AndroidSigningKeyStore=thebutton.keystore -p:AndroidSigningKeyAlias=${{ secrets.ANDROID_KEY_ALIAS }} -p:AndroidSigningKeyPass=${{ secrets.ANDROID_KEY_PASSWORD }} -p:AndroidSigningStorePass=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

    - name: Upload AAB
      uses: actions/upload-artifact@v4
      with:
        name: android-release-aab
        path: src/TheButton.Mobile/bin/Release/net10.0-android/publish/*.aab

  release-ios:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        global-json-file: global.json
        
    - name: Install MAUI
      run: dotnet workload install maui-ios

    - name: Import Certificate & Profile
      env:
        P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
        P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
        PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # Create keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        
        # Decode P12 and import
        echo $P12_BASE64 | base64 --decode > cert.p12
        security import cert.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
        
        # Decode Profile
        echo $PROFILE_BASE64 | base64 --decode > profile.mobileprovision
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

    - name: Build and Sign IPA
      run: |
        dotnet publish src/TheButton.Mobile/TheButton.Mobile.csproj -f net10.0-ios -c Release -p:ArchiveOnBuild=true -p:CodesignKey="${{ secrets.IOS_CODESIGN_KEY }}" -p:CodesignProvision="${{ secrets.IOS_PROVISIONING_PROFILE_NAME }}"

    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-release-ipa
        path: src/TheButton.Mobile/bin/Release/net10.0-ios/publish/*.ipa

  e2e-verification:
    needs: [release-android, release-ios]
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        global-json-file: global.json
        
    - name: Install MAUI Workload
      run: dotnet workload install maui-android maui-ios

    - name: Install Maestro
      run: |
        curl -Ls "https://get.maestro.mobile.dev" | bash
        echo "$HOME/.maestro/bin" >> $GITHUB_PATH
        
    # Start Mock API
    - name: Start Mock API
      run: |
        dotnet run --project tools/TheButton.MockApi/TheButton.MockApi.csproj --urls "http://localhost:5001" &
        echo "Mock API started"

    # iOS Verification
    - name: Run iOS Simulator and Maestro
      run: |
         # Config for iOS (localhost works for simulator)
         # Build for simulator (not signed, for testing)
         echo '{"BaseApiUrl": "http://localhost:5001/"}' > src/TheButton.Mobile/appsettings.json
         
         dotnet build src/TheButton.Mobile/TheButton.Mobile.csproj -f net10.0-ios -c Release -t:Run -p:RuntimeIdentifier=iossimulator-x64
         
         $HOME/.maestro/bin/maestro test .maestro/ios-flow.yaml

    - name: Upload Maestro Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: maestro-reports
        path: ~/.maestro/tests/**/*
