name: iOS E2E

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_MULTILEVEL_LOOKUP: 0
  MAESTRO_DRIVER_STARTUP_TIMEOUT: 60000
  IOS_RUNTIME_MAJOR: "18"
  IOS_DEVICE_TYPE_NAME: "iPhone 16"

jobs:
  ios-e2e:
    # Use macOS 15+ for Xcode 26.x toolchain.
    # Prefer arm64 runners if you build iossimulator-arm64.
    runs-on: macos-15

    steps:
      - uses: actions/checkout@v4

      # Pin Xcode 26.1.1 for now (26.2 availability on hosted runners can lag).
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "26.1.1"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Install Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Use restore (preferred in CI) and prevent manifest updates to avoid unintended Xcode bumps.
      - name: Restore MAUI workloads (pinned)
        run: |
          dotnet --info
          xcodebuild -version
          dotnet workload restore src/TheButton.Mobile/TheButton.Mobile.csproj --skip-manifest-update --ignore-failed-sources
          dotnet workload --info

      - name: Install Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
          echo "Maestro version:"
          ~/.maestro/bin/maestro --version

      - name: Run iOS E2E Tests
        run: |
          chmod +x scripts/run-ios-e2e.sh
          ./scripts/run-ios-e2e.sh

      # Always upload Maestro test artifacts for debugging
      - name: Upload Maestro Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-report-ios
          path: ~/.maestro/tests/**/*
          if-no-files-found: ignore

      # Upload additional diagnostics on failure
      - name: Upload Failure Diagnostics
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-e2e-diagnostics
          path: |
            mock_api.log
            ~/Library/Logs/CoreSimulator/**/*
          if-no-files-found: ignore
